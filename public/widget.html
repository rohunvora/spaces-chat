<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Widget</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: #00ff00; /* Default to green for chromakey */
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }
    
    #messages {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    
    /* Fade gradient for overflow */
    #messages::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(to bottom, #00ff00, transparent);
      pointer-events: none;
      z-index: 1;
    }
    
    #messages::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(to top, #00ff00, transparent);
      pointer-events: none;
      z-index: 1;
    }
    
    /* Adjust gradient color based on chromakey */
    body.chromakey-blue #messages::before,
    body.chromakey-blue #messages::after {
      background: linear-gradient(to bottom, #0000ff, transparent);
    }
    
    body.chromakey-magenta #messages::before,
    body.chromakey-magenta #messages::after {
      background: linear-gradient(to bottom, #ff00ff, transparent);
    }
    
    body.chromakey-none #messages::before,
    body.chromakey-none #messages::after {
      display: none;
    }
    
    #messages.direction-up {
      flex-direction: column-reverse;
      justify-content: flex-start;
    }
    
    #messages.direction-down {
      flex-direction: column;
      justify-content: flex-end;
    }
    
    .message {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.85));
      color: white;
      padding: 14px 18px;
      border-radius: 10px;
      width: 100%;
      max-width: 650px;
      animation: slideIn 400ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
      word-wrap: break-word;
      font-size: 20px;
      line-height: 1.45;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border-left: 3px solid rgba(16, 185, 129, 0.8);
      transition: opacity 300ms ease-out, transform 300ms ease-out;
    }
    
    .message.fade-out {
      opacity: 0;
      transform: translateX(-20px);
    }
    
    .message-name {
      font-weight: 700;
      margin-right: 8px;
      font-size: 21px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }
    
    .message-text {
      display: inline;
      font-size: 20px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }
    
    /* Chromakey-friendly background options */
    body.chromakey-green {
      background: #00ff00 !important; /* Pure green for chroma key */
    }
    
    body.chromakey-blue {
      background: #0000ff !important; /* Pure blue for chroma key */
    }
    
    body.chromakey-magenta {
      background: #ff00ff !important; /* Pure magenta for chroma key */
    }
    
    /* No chromakey - transparent background */
    body.chromakey-none {
      background: transparent !important;
    }
  </style>
</head>
<body>
  <div id="messages"></div>
  
  <script>
    const params = new URLSearchParams(window.location.search);
    const direction = params.get('direction') || 'up';
    const maxMessages = parseInt(params.get('max')) || 20;
    const chromakey = params.get('chromakey');
    
    const messagesEl = document.getElementById('messages');
    messagesEl.className = `direction-${direction}`;
    
    if (chromakey) {
      document.body.className = `chromakey-${chromakey}`;
    }
    
    let messages = [];
    let ws = null;
    
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        ws.send(JSON.stringify({
          type: 'hello',
          name: 'Widget',
          host: false
        }));
      };
      
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleMessage(msg);
        } catch (err) {
          console.error('Parse error:', err);
        }
      };
      
      ws.onclose = () => {
        setTimeout(connectWebSocket, 2000);
      };
    }
    
    function handleMessage(msg) {
      switch (msg.type) {
        case 'system':
          if (msg.messages) {
            messages = msg.messages.slice(-maxMessages);
            renderMessages();
          }
          break;
          
        case 'msg':
          messages.push(msg);
          if (messages.length > maxMessages) {
            messages.shift();
          }
          renderMessages();
          break;
          
        case 'delete':
          messages = messages.filter(m => m.id !== msg.id);
          renderMessages();
          break;
          
        case 'reset':
          messages = [];
          renderMessages();
          break;
      }
    }
    
    function renderMessages() {
      messagesEl.innerHTML = messages.map(msg => {
        let replyContent = '';
        if (msg.replyTo) {
          replyContent = `<div style="font-size: 0.8em; opacity: 0.7; margin-bottom: 2px;">â†³ ${escapeHtml(msg.replyTo.name)}: ${escapeHtml(msg.replyTo.text.substring(0, 30))}...</div>`;
        }
        return `
          <div class="message">
            ${replyContent}
            <span class="message-name" style="color: ${getUserColor(msg.name)}">${escapeHtml(msg.name)}:</span>
            <span class="message-text">${escapeHtml(msg.text)}</span>
          </div>
        `;
      }).join('');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function getUserColor(name) {
      const colors = [
        '#e11d48', '#dc2626', '#ea580c', '#ca8a04',
        '#16a34a', '#059669', '#0891b2', '#2563eb',
        '#7c3aed', '#c026d3', '#db2777', '#0f766e',
        '#7c2d12', '#1e40af', '#6b21a8'
      ];
      
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = ((hash << 5) - hash) + name.charCodeAt(i);
        hash = hash & hash;
      }
      
      return colors[Math.abs(hash) % colors.length];
    }
    
    connectWebSocket();
  </script>
</body>
</html>